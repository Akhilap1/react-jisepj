<!DOCTYPE html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>Queued Jobs</title>


    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>Queued Jobs</title>
<!--         <link rel="stylesheet" type="text/css" href= "https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"> </style>  -->
   <link rel="stylesheet" type="text/css" href= "http://www.serc.iisc.ac.in/~hpc/WebPages/css/bootstrap.min.css">
<!--  <script type="text/javascript" src="http://www.serc.iisc.ac.in/~hpc/WebPages/css/bootstrap-datepicker.min.js"></script> -->
 <link rel="stylesheet" href="http://www.serc.iisc.ac.in/~hpc/WebPages/css/bootstrap-datepicker3.css"/>
    <link rel="stylesheet" type="text/css" href="http://www.serc.iisc.ac.in/~hpc/WebPages/css/dc.css"/> 
<!-- 	    <link rel="stylesheet" type="text/css" href= "https://cdn.datatables.net/1.10.15/css/dataTables.bootstrap.min.css">  </style>  -->
        <link rel="stylesheet" type="text/css" href= "http://www.serc.iisc.ac.in/~hpc/WebPages/css/dataTables.bootstrap.min.css">  </style> 
<!--   		<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/dc/2.1.6/dc.css"></style>   -->
<!--         <link rel="stylesheet" href="http://cdn.datatables.net/1.10.2/css/jquery.dataTables.min.css"></style>  -->
        <link rel="stylesheet" href="http://www.serc.iisc.ac.in/~hpc/WebPages/css/jquery.dataTables.min.css"></style>
        <link rel="stylesheet" href="http://www.serc.iisc.ac.in/~hpc/WebPages/css/jquery-ui.css">
<!--        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.4.1/css/bootstrap-datepicker3.css"/>  -->
        <link rel="stylesheet" href="http://www.serc.iisc.ac.in/~hpc/WebPages/css/bootstrap-datepicker3.css"/>
	<!-- <link rel="stylesheet" href="https://unpkg.com/flatpickr/dist/flatpickr.min.css">  -->
        <link rel="stylesheet" href="http://www.serc.iisc.ac.in/~hpc/WebPages/css/flatpickr.min.css">
<!--     <script src="https://unpkg.com/flatpickr"></script>  -->

<!--    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script> 
        <script type="text/javascript" src="http://cdn.datatables.net/1.10.2/js/jquery.dataTables.min.js"></script> 
        <script type="text/javascript" src="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script> 
		<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
        <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
        <script type="text/javascript" src="canvasJS/canvasjs.min.js"></script> -->

       <script type="text/javascript" src="http://www.serc.iisc.ac.in/~hpc/WebPages/js/jquery.min.js"></script>
        <script type="text/javascript" src="http://www.serc.iisc.ac.in/~hpc/WebPages/js/jquery.dataTables.min.js"></script>
        <script src="http://www.serc.iisc.ac.in/~hpc/WebPages/js/jquery-1.12.4.js"></script>
        <script src="http://www.serc.iisc.ac.in/~hpc/WebPages/js/jquery-ui.js"></script>
                <script type="text/javascript" src="canvasJS/canvasjs.min.js"></script>


<!--         <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/crossfilter/1.3.12/crossfilter.js"></script> 
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.js" charset="utf-8"></script> 
        <script src="https://d3js.org/d3-queue.v3.min.js"></script> 
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/dc/2.1.6/dc.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jsencrypt/2.3.1/jsencrypt.min.js"></script>
		<script src = "https://cdn.plot.ly/plotly-latest.min.js"></script>bar -->
      <script type="text/javascript" src="http://www.serc.iisc.ac.in/~hpc/WebPages/js/crossfilter.js"></script>
        <script type="text/javascript" src="http://www.serc.iisc.ac.in/~hpc/WebPages/js/d3.js" charset="utf-8"></script>
        <script src="http://www.serc.iisc.ac.in/~hpc/WebPages/js/d3-queue.v3.min.js"></script>
        <script type="text/javascript" src="http://www.serc.iisc.ac.in/~hpc/WebPages/js/dc.js"></script>
    <script src="http://www.serc.iisc.ac.in/~hpc/WebPages/js/jsencrypt.min.js"></script>

<script src="http://www.serc.iisc.ac.in/~hpc/WebPages/js/plotly-latest.min.js"></script>
<style> /* set the CSS */

.line {
  fill: none;
  stroke: steelblue;
  stroke-width: 2px;
}


/* Ensure that the demo table scrolls */
/* Ensure that the demo table scrolls */
    th, td { white-space: wrap; }
.table-condensed{
  font-size: 12px;
}
</style>

    <script> 
    $(function(){
	//$("#sidebar").load("SideBar.html");
			verifyLogin(true);
			//setNavigation();

	});

	function verifyLogin(mustVerify) {

		if (mustVerify == true)
		{

			  $.ajax({
					type:'GET',
					url:"PHP/SideBar.php",      
					success:function(res, textStatus, jXHR) {

						try {
								$ext_auth = JSON.parse(res );
								if( $ext_auth['result']  == 1 ) {
									console.log("Login Success "+res);

									if ($ext_auth['role'] == "admin")
									{
										$("#sidebar").load("SideBarAdminNew.html");

									}
									else
									{
										$("#sidebar").load("SideBarNew.html");
									}

									//$("#sidebar").load("SideBar.html");
									$('#LoginLogout').html("Logout");
									//setNavigation();
								}
								else{
					 				alert("Please Login");
							   		$("#page-content-wrapper").hide();
									$("#sidebar").load("PHP/UserLogin.php");
								}
					}catch(e)
					{
			 				alert(res);
					   		$("#page-content-wrapper").hide();
							$("#sidebar").load("PHP/UserLogin.php");

					}
					}, error: function(request,testStatus,errorThrown) {
						alert("Please Login");
					   $("#page-content-wrapper").hide();
					   $("#sidebar").load("PHP/UserLogin.php");
					}
				});

		}
		else {
		
				$('#LoginLogout').html("Logout");
				///LoginLogout
				//setNavigation();
		}
	}



	function setNavigation() {
		var path = window.location.pathname;
		path = path.replace(/\/$/, "");
		path = decodeURIComponent(path);
		var filename = path.substr(path.lastIndexOf("/")+1);
		//alert(filename);
		$(".nav-stacked a").each(function () {
		    var href = $(this).attr('href');
			href = href.substr(href.lastIndexOf("/")+1);
		    if (href == filename) {
		        $(this).closest('li').addClass('active');
		    }
		});
	}
 
    </script> 
</head>

<body>
 <div >
	<img src = "../HOME/facility-header-nodiv-crop.png" width ="100%"/>
  </div>


    <div id="wrapper">
      <!-- Sidebar -->
 		<div id="sidebar"></div>
		<div id= "NoQueuedJobsStatusMsg" style="display:none">
			<p style="font-familty:verdana; font-size:300%; text-align:center; "> There are currently no Jobs Queued on SahsaraT</p>
		</div>


        <!-- Page Content -->
        <div id="page-content-wrapper">
            <div id="auth-spinner" style="display:none;"><center><img src="ajax-loader.gif"></center></div>
			<button id="bRefresh" type="button" onclick="pollFunc(readAllCSVs, 100000, 10000);" class="btn btn-success"">Refresh</button>

            <div class="container-fluid xyz">
                <div class="row">
 					<div id="head1" class="col-sm-12" >	
					  <div class="col-sm-12" >
					    <div  id="select1" style="border-none" ;>
							<p>	<a class="reset" href='javascript:select1.filterAll();dc.redrawAll();' style='visibility: hidden;'>reset</a></p>
						</div>
					 </div>
					</div>
				</div>
                <div class="row">
					</br>
				</div>
                <div class="row">
					<div id="head1" class="col-sm-12" >	
				        <div class="col-sm-6"   style="display:none">
		 					<div class="panel panel-success" style="border-none" ;>
					            <div class="panel-heading" style="border-bottom:5px solid green ;" >
								Jobs by Supervisor
					            </div>
							</div>
							<div  class="panel-body" id = "Container1" style="height: 800px; " >
							  <div id="chart-bar-sup" style="width:400px; height:600px">
								<div class="reset btn btn-success" style="visibility: hidden;">range: <span class="filter"></span>
								  <a href="javascript:supervisorRowChart.filterAll();dc.redrawAll();">reset</a>
								</div>
							  </div>
							</div>
						</div>
				        <div class="col-lg-12">
		 					<div class="panel panel-success">
					            <div id="custom_heading" class="panel-heading" style="border-bottom:5px solid green;" >
								Usage by Nodes requested
					            </div>
							</div>
							<!---div id = "ContainerBar"  -->
			                  <div class="row">
							  <div class = "col-lg-3" id ="custom_user_pie" style="width:500px; height:300px"></div>
							  <div class = "panel-body col-lg-3" id="chart-ring-queue" style="width:500px; height:330px">Number of Jobs by Queue
									[Click on a QUEUE on the pie to customise for that Queue]
								<div class="reset btn btn-success" style="visibility: hidden;">selected: <span class="filter"></span>
								  <a href="javascript:queueRingChart.filterAll();dc.redrawAll();">reset</a>
								</div>
							  </div>
							 
							  <div  class = "panel-body  col-lg-3" id="chart-ring-dept" style="width:500px; height:300px">Number of Jobs by Department
									[Click on a DEPT on the pie to customise for that DEPT]
								<div class="reset btn btn-success" style="visibility: hidden;">range: <span class="filter"></span>
								  <a href="javascript:deptRingChart.filterAll();dc.redrawAll();">reset</a>
								</div>
							  </div>
							</div>
							<!--/div -->
						</div>
						<div class="col-lg-12" id="chart_bar" style="height:600px">
						</div>
				        <div class="col-lg-12">
		 					<div class="panel panel-success">
					            <div class="panel-heading" style="border-bottom:5px solid green;" >
								List of Jobs on Queue
					            </div>
							</div>
						    <div class='row'>
							<div class='span25'>
									<table id="dc-table-graph" class="table table-striped table-bordered table-condensed" cellspacing="0" width="100%" >  
									<thead>
									  <tr class='header'>
										<th>Supervisor</th>
										<th>Dept</th>
										<th>Queue</th>
										<th>Username</th>
										<th>JobID</th>
										<th>Nodes</th>
										<th> Create Time</th>
										<th> Estimated StartTime</th>
										<th> Comment</th>
										<th> WallTime </th>
									  </tr>
									</thead>
								  </table>
							</div>
							</div>
							</div>
						</div>
				        <div class="col-lg-4" style="display:none">
		 					<div class="panel panel-success">
					            <div class="panel-heading" style="border-bottom:5px solid green;" >
								Jobs by Supervisor
					            </div>
							</div>
							<div class="panel-body" id = "ContainerBar" style="height: 400px;  " >

							  <div id="chart-ring-sup" style="width:300px; height:300px">Number of jobs - by Research Group
									[Click on a Research Group on the pie to customise]
								<div class="reset btn btn-success" style="visibility: hidden;">range: <span class="filter"></span>
								  <a href="javascript:supRingChart.filterAll();dc.redrawAll();">reset</a>
								</div>
							  </div>
							</div>
						</div>

				  </div>
				</div>
			</div>
		</div>
		</div>


<script type="text/javascript">

//var table = dc.dataTable('#table');
$.noConflict();

//var barchart   = dc.barChart("#chart-bar");
var queueRingChart   = dc.pieChart("#chart-ring-queue");
var deptRingChart = dc.pieChart("#chart-ring-dept");
var supRingChart = dc.pieChart("#chart-ring-sup");
//var supervisorBarChart = dc.barChart("#chart-bar-sup");
var supervisorRowChart = dc.rowChart("#chart-bar-sup");

var ALLDATA = null;
var chart = dc.dataTable("#dc-table-graph");
var select1 = dc.selectMenu('#select1');
var LoginUserId ="";
var LoginUserName = "";
var LoginUserRole ="";
//#################################################################
$(document).ready(function () {

	readAllCSVsFromPhp();
	//readAllCSVs();
	//pollFunc(readAllCSVs, 100000, 10000);
});

//#################################################################
function readAllCSVsFromPhp()
{

 var JobsData = [];
 var UserData = [];
 var DeptData = [];
 var LoginData = [];
 $('#auth-spinner').show();
 $.ajaxSetup({async: false});

 $.ajax({
       type: "GET",
        url: "PHP/getUserData.php",
 		data: { dataname: "AllQueuedJobs"},
        success: function(response) {
			JobsData = JSON.parse(response);
			console.log(JobsData);

			}, error: function(request,testStatus,errorThrown) {
			alert(errorThrown);
            console.log("Login Failed" + errorThrown);
        }
    });

 $.ajax({
       type: "GET",
        url: "PHP/getUserData.php",
 		data: { dataname: "Departments"},
        success: function(response) {
			DeptData = JSON.parse(response);
			console.log(DeptData);

			}, error: function(request,testStatus,errorThrown) {
			alert(errorThrown);
            console.log("Login Failed" + errorThrown);
        }
    });

 $.ajax({
       type: "GET",
        url: "PHP/getUserData.php",
 		data: { dataname: "UserInformation"},
        success: function(response) {
			UserData = JSON.parse(response);
			console.log(UserData);

			}, error: function(request,testStatus,errorThrown) {
			alert(errorThrown);
            console.log("Login Failed" + errorThrown);
        }
    });

 $.ajax({
       type: "GET",
        url: "PHP/getUserData.php",
 		data: { dataname: "LoginInformation"},
        success: function(response) {
			LoginData = JSON.parse(response);
			console.log(LoginData);

			}, error: function(request,testStatus,errorThrown) {
			alert(errorThrown);
            console.log("Login Failed" + errorThrown);
        }
    });
//  doStuff(JobsData, DeptData, UserData, LoginData);
//  $.ajaxSetup({async: true});

if (JobsData == null)
{
	$("#NoQueuedJobsStatusMsg").show();
	$("#page-content-wrapper").hide();
}
else
{
	$("#NoQueuedJobsStatusMsg").hide();
	$("#page-content-wrapper").show();
	doStuff(JobsData, DeptData, UserData, LoginData);
}
 $('#auth-spinner').hide();
//doStuff(JobsData, DeptData, UserData, LoginData);
  $.ajaxSetup({async: true});

}


///###################################################################
function readAllCSVs(){
	d3.queue()
	.defer(d3.csv, "./DATA/RunningJobs.csv")
	.defer(d3.csv, "./DATA/QueuedJobs.csv")
	.defer(d3.csv, "./DATA/Depts.csv")
	.defer(d3.csv, "./DATA/CrayUserData.csv")
	.await(function(error, file1, file2, file3, file4) {
		if (error) {
		    console.error('Oh dear, something went wrong: ' + error);
		}
		else {
		    doStuff(file2, file3, file4);
		}
	});
}

///################################################################
//#################################################################
function join(lookupTable, mainTable, lookupKey, mainKey, select) {
    var l = lookupTable.length,
        m = mainTable.length,
        lookupIndex = [],
        output = [];
    for (var i = 0; i < l; i++) { // loop through l items
        var row = lookupTable[i];
        lookupIndex[row[lookupKey]] = row; // create an index for lookup table
    }
    for (var j = 0; j < m; j++) { // loop through m items
        var y = mainTable[j];
        var x = lookupIndex[y[mainKey]]; // get corresponding row from lookupTable
		if (x === undefined)
		{
			x = y[mainKey];
			//alert("Missing Information for " + y[mainKey] + " Please add to tables");
			output.push(select(y, x)); // select only the columns you need
		}
		else
		{
        	output.push(select(y, x)); // select only the columns you need
		}
    }
    return output;
};


///################################################################
//##################################################################
//##################################################################
function customPieChartForUserorSuperVisor(iDataSet, allData)
{

var titleStr = "<b>Share of System resources [Nodes] requested by </b>\n";

if(LoginUserRole == "SUPERVISOR")
{
	titleStr += "Research Group of " + LoginUserName;
}
else
{
	titleStr += LoginUserName;

}
$("#custom_heading").html(titleStr);
var layout = {
//title:titleStr,
showlegend: true,
  height: 500,
  width: 500
};


var total_nodes = d3.sum(allData, function(d) { return d.nodes;})

var expenseMetrics = d3.nest()
  .key(function(d) { return d.username; })
  .rollup(function(v) { return {
    total: d3.sum(v, function(d) { return d.nodes; })
  }; })
  .entries(iDataSet);


var uniqueUsers = expenseMetrics.map(function(d) {
	return d.key;
});

var uniqueUsage = expenseMetrics.map(function(d) {
	return d.values["total"];
});


uniqueUsers.push("Others");
uniqueUsage.push(total_nodes - d3.sum(iDataSet, function(d) { return d.nodes;}));

var data = [{
  values: uniqueUsage,
  labels: uniqueUsers,
  type: 'pie',
  name: '%',
 // marker: {
 //   colors: ultimateColors[0]
 // },
  hoverinfo: 'label+percent+name',
  textinfo: 'none'
}]
 
Plotly.newPlot('custom_user_pie', data, layout);


}

function valid(data) {
    return data != false;
}
//#################################################################
function doStuff(QdJobData, DeptData, UserData, LoginData)
{
	var today = new Date();
	var parseDate = d3.time.format("%d%b%Y %H:%M");
	var columns = ['username','queue','nodes','JobStart'];
  	var currentYear = today.getFullYear();
	var prevYear = currentYear -1;

if (null == LoginData)
{
	alert("Please login!");
}
else
{
	LoginUserName = LoginData.username;
	LoginUserId = LoginData.userid;
	LoginUserRole = LoginData.role;
}
	QdJobData = QdJobData.filter(valid);

	UserData.forEach(function(data) {
		data.index = data.index;
		data.userid = data.userid.substring(0,8);
		data.username = data.username;
		data.course = data.course;
		data.supervisor2 = data.supervisor2;
		data.Dept = data.Dept;
	});

	QdJobData.forEach(function(data) {
		if (data != false)
		{
			data.JobID = data.JobID;
			data.username = data.username;
			data.queue = data.queue;
			data.nodes = +data.nodes;
			data.comment = data.comment;
			data.rwalltime = data.rwalltime;
			data.dept = data.username.substr(0, 3) ;
			data.estStartTime = data.estart_time;
			data.ctime = data.ctime;
			if (data.dept.substr(0,2) == "ug")
			{
				data.dept="ug";
			}
		}
	});


	//##################################################################
	DeptData.forEach(function(data) {
		data.Acronym = data.Acronym;
		data.Definition = data.Definition;
		//console.log(data);
	});

	//console.log(file1);
	//var	r1 = join(DeptData, JobData, "Acronym", "dept");
	var result = join(DeptData, QdJobData, "Acronym", "dept", 
						function(Job, Dept) {
												return { //Dept,Job

													JobID: Job.JobID,
													userid: Job.username,
													queue: 	Job.queue,
													nodes: 	Job.nodes,
													dept:	Job.dept,
													deptName: Dept.Definition,
													estStartTime: Job.estStartTime,
													createTime:Job.ctime,
													comment:Job.comment,
													rwalltime:Job.rwalltime

												};
											});


	DeptData.forEach(function(data) {
		data.Acronym = data.Acronym;
		data.Definition = data.Definition;
		//console.log(data);
	});

	//console.log(file1);
	//var	r1 = join(DeptData, JobData, "Acronym", "dept");
	var QueuedJobData = join(UserData, result, "userid", "userid", 
						function(job, user) {
												return { //Dept,Job

													JobID: job.JobID,
													userid: job.userid,
													queue: 	job.queue,
													nodes: 	job.nodes,
													date: 	job.date,
													time:	job.time,
													dept:	job.dept,
													estStartTime: job.estStartTime,
													createTime:job.createTime,
													comment:job.comment,
													rwalltime:job.rwalltime,
													//corehours: job.corehours,
													deptName: job.deptName,
													username: user.username,
													supervisor:user.supervisor2
												};
											});


QueuedJobData.forEach(function(data) {
		if (data.username === undefined)
		{
			data.username = data.userid;
		}
	});


	var filteredData = 	QueuedJobData;

	if (LoginUserRole == "SUPERVISOR")
	{
	   filteredData = QueuedJobData.filter(function (d) {return d.supervisor === LoginUserName;});
		$("#select1").hide();
		$("#chart-ring-queue").hide();
		$("#chart-ring-user").hide();
		$("#chart-ring-sup").hide();
		$("#chart-ring-dept").hide();

		customPieChartForUserorSuperVisor(filteredData, result);
	}
	else if (LoginUserRole == "USER")
	{
	   filteredData = QueuedJobData.filter(function (d) {return d.userid === LoginUserId;});
		$("#select1").hide();
		$("#chart-ring-user").hide();
		$("#chart-ring-sup").hide();
		$("#chart-ring-dept").hide();
		$("#chart-ring-queue").hide();
		customPieChartForUserorSuperVisor(filteredData, result);
	}
	else
	{
	  $('#custom_user_pie').hide();
	}
	console.log(filteredData);
	console.log(result);

    ALLDATA = filteredData;
	if (filteredData.length == 0)
	{
		alert('No Queued Jobs for ' + LoginUserName);
		$("#custom_user_pie").hide();
		//SummariseUsingCrossFilter(QueuedJobData, QueuedJobData);
	}
	else
	{
		SummariseUsingCrossFilter(filteredData, QueuedJobData);
	}


 
}

//################################################################
function SummariseUsingCrossFilter(filteredData, QueuedJobData)
{

	// set crossfilter
	var ndx = crossfilter(filteredData),
    commentDimension = ndx.dimension(function(d) {return d.comment;}),
    queueDim  = ndx.dimension(function(d) {return d.queue;}),
    deptDim = ndx.dimension(function(d) {return d.deptName;}),
    userDim  = ndx.dimension(function(d) {return d.username;}),
    jobidDim = ndx.dimension(function(d) {return d.JobID;}),
    supDim = ndx.dimension(function(d) {return d.supervisor;}),
    numJobsPerQueue = queueDim.group().reduceCount(),
 	numJobsPerDept = deptDim.group().reduceCount(),
 	numJobsPerUser = userDim.group().reduceCount(),
    numJobsPerJobID = jobidDim.group().reduceCount(),
    numJobsPerSup = supDim.group().reduceCount(),
    sumCommentsGroup       = commentDimension.group().reduceCount();

	//    spendPerName = nameDim.group().reduceSum(function(d) {return +d.Spent;}),

  //###########  Ring Chart for Queue wise breakup of Jobs
  queueRingChart
    .width(500)
    .height(250)
	.cx(150)
	.cy(0)
    .slicesCap(10)
    .innerRadius(50)
      //    .externalLabels(30)
    .externalRadiusPadding(10)
    .drawPaths(true)
    .legend(dc.legend().x(300).y(30))
    .dimension(queueDim)
    .group(numJobsPerQueue)
    .controlsUseVisibility(true);



      // example of formatting the legend via svg
      // http://stackoverflow.com/questions/38430632/how-can-we-add-legends-value-beside-of-legend-with-proper-alignment
      queueRingChart.on('pretransition', function(chart) {
          queueRingChart.selectAll('.dc-legend-item text')
              .text('')
            .append('tspan')
              .text(function(d) { return d.name; })
            .append('tspan')
              .attr('x', 100)
              .attr('text-anchor', 'end')
              .text(function(d) { return d.data; });
      });

  //###########  Ring Chart for Queue wise breakup of Jobs
  deptRingChart
   .width(500)
    .height(250)
	.cx(150)
	.cy(0)
    .slicesCap(10)
    .innerRadius(50)
      //    .externalLabels(50)
      //    .externalRadiusPadding(50)
    .externalRadiusPadding(10)
    .drawPaths(true)
    .legend(dc.legend().x(300).y(20))
    .dimension(deptDim)
    .group(numJobsPerDept)
    .controlsUseVisibility(true);



 //###########  Ring Chart for Queue wise breakup of Jobs
  supRingChart
    .width(500)
    .height(250)
    .slicesCap(10)
    .innerRadius(50)
      //    .externalLabels(50)
      //    .externalRadiusPadding(50)
     .drawPaths(true)
     //   .legend(dc.legend())
    .dimension(supDim)
    .group(numJobsPerSup)
    .innerRadius(50)
   .controlsUseVisibility(true);


 supervisorRowChart
	.cap(15)
    .width(600)
    .height(600)
 	.dimension(supDim)
    .group(numJobsPerSup)
	.ordering(function(t){return -t.value;})
    .controlsUseVisibility(true);

 
    chart
        .width(700)
        .height(500)
        .dimension(jobidDim)
        .group(function(d) {return d.JobId;})
        .size(Infinity)
	    .showGroups(false)
        .columns([function (d) { return d.supervisor },
              function (d) { return d.dept },
              function (d) { return d.queue },
              function (d) { return d.username }, 
              function (d) { return d.JobID }, 
			  function (d) {return d.nodes},
			  function (d) {return d.createTime}, 
			  function (d) {return d.estStartTime},
			  function (d) {return d.comment},
			  function (d) {return d.rwalltime}
			 ])
        .order(d3.ascending);

	// create a select menu under #select-container using the default global chart group
    select1.dimension(supDim)
    .group(supDim.group())
	.promptText('All Supervisors')
    .controlsUseVisibility(true);

     plotBarchart(filteredData);
	 //barchart
     //     .width(768)
     //     .height(380)
     //     .x(d3.scale.ordinal().rangeRoundBands([0, width], .1) )
     //     .xUnits(dc.units.ordinal)
     //     .brushOn(false)
     //     .xAxisLabel('Comment')
     //     .yAxisLabel('Number of Jobs')
     //   .dimension(queueDim)
     //     .barPadding(0.1)
     //     .outerPadding(0.05)
     //     .group(numJobsPerQueue);
     //barchart.render();

	dc.renderAll();
    $('#dc-table-graph').DataTable();


}

//#################################################################
function plotBarchart(allData)
{

///apply filter based on queue and dept pie charts
filteredData = allData;
  if (queueRingChart.filters() != "")
  {
	filteredData = filteredData.filter(function (d) {return queueRingChart.filters().indexOf(d.queue) >=0 ;});
  }
  if (deptRingChart.filters() != "")
  {
	
	filteredData = filteredData.filter(function (d) {return deptRingChart.filters().indexOf(d.dept) >=0 ;});
   }
	var ndx = crossfilter(filteredData),
    commentDimension = ndx.dimension(function(d) {return d.comment;}),
    sumCommentsGroup       = commentDimension.group().reduceCount();

var keys = sumCommentsGroup.all().map(function(d) {
	var s = d.key;

    if (s != "")
	{
	 s = s.replace("comment = ", "");
	 s = s.replace("Not Running:", "");
	}
	return s;
});

var values = sumCommentsGroup.all().map(function(d) {
	return d.value;
});


var trace1 = {
  x: values,
  y: keys,
  xaxis: 'x',
  yaxis: 'y',
  type: 'bar',
  marker: {
    color: 'rgba(50,171,96,0.6)',
    line: {
      color: 'rgba(50,171,96,1.0)',
      width: 1
    }
  },
  name: 'Why are these jobs still on Queue',
  orientation: 'h'
};

var data = [trace1];
var layout = {
  title: 'Distribution of Queued jobs by Scheduler comments',
  xaxis1: {
    zeroline: false,
    showline: false,
    showticklabels: true,
    showgrid: true
  },
 
  legend: {
    x: 0.029,
    y: 1.238,
    font: {
      size: 10
    }
  },
  margin: {
    l: 300,
    r: 20,
    t: 100,
    b: 70
  },
  //width: 600,
  //height: 600,
  paper_bgcolor: 'rgb(248,248,255)',
  plot_bgcolor: 'rgb(248,248,255)',
  annotations: [
    {
      xref: 'paper',
      yref: 'paper',
      x: -0.2,
      y: -0.109,
      showarrow: false,
      font:{
        family: 'Arial',
        size: 10,
        color: 'rgb(150,150,150)'
      }
    }
  ]
};


Plotly.newPlot('chart_bar', data, layout);



}

//################################################################
function readQueuedJobs() {

	var QueuedJobData;
   d3.csv("./QueuedJobs.csv", function(csv_data){

		csv_data.JobID = csv_data.JobID;
		csv_data.username = csv_data.username;
		csv_data.queue = csv_data.queue;
		csv_data.nodes = +csv_data.nodes;
		QueuedJobData = csv_data;


	QueuedJobData.forEach(function(data) {
		data.JobID = data.JobID;
		data.username = data.username;
		data.queue = data.queue;
		data.nodes = +data.nodes;
		data.dept = data.username.substr(0, 3) ;

		if (data.dept.substr(0,2) == "ug")
		{
			data.dept="ug";
		}

	});

	
});
}


deptRingChart.on('filtered.chart-ring-queue', function() {
    plotBarchart(ALLDATA);
    //alert(deptRingChart.filters().join(','));


});

queueRingChart.on('filtered.chart-ring-queue', function() {
    plotBarchart(ALLDATA);
    //alert(queueRingChart.filters().join(','));


});

//###############################################
function reinit(chart)
{
    // Get the div id of the chart requesting to be DataTable'd
    var chart_anchor_id = '#' + chart.anchorName()
    // Destroy the current DataTable (if any)
    t = new $.fn.dataTable.Api($(chart_anchor_id))
    t.destroy()
    // Remove the 'group' as this won't work with DataTables
    $(chart_anchor_id + ' .dc-table-group').remove()
    // Reinit the jQuery dataTable
    $(chart_anchor_id).dataTable({bFilter: false});
};


chart.on("postRender", function(chart){reinit(chart)}).on("postRedraw", function(chart){reinit(chart)});


//#########################################################

function pollFunc(fn, timeout, interval) {
    var startTime = (new Date()).getTime();
    interval = interval || 1000;
    canPoll = true;
    (function p() {
	///alert("refreshing");
	 $('#StatusMsg').empty();
			divData='   <div> '+ 'Last Updated at ....<b>' + new Date() +	'</b>'+	
						'</div>';

		
			$('#StatusMsg').append(divData);


				canPoll = ((new Date).getTime() - startTime ) <= timeout;
				if (!fn() && canPoll)  { // ensures the function exucutes
				    setTimeout(p, interval);
				}
				if (canPoll)
				{
					//$('#bRefresh').Enable
				    $("#bRefresh").attr("disabled", true);

				}
				else
				{
					$("#bRefresh").removeAttr("disabled");
				}
	
    })();
}
</script>
<!-- script src="../HOME/HPC_AccountingSideBAR.js"></script -->

</body>
</html>
